generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id // Telegram ID
  username  String?
  firstName String?
  lastName  String?
  photoUrl  String?
  role      String   @default("user") // "user", "admin"
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  copySettings CopySetting[]
  alerts       Alert[]

  @@map("users") // Table name in DB
}

model Signal {
  id              String   @id @default(cuid())
  marketId        String   @unique
  question        String
  slug            String
  score           Int
  reason          String
  volume          Float
  liquidity       Float
  newsCorrelation Boolean
  source          String   @default("RADAR") // RSS, TWITTER, RADAR, MANUAL
  metadata        Json? // Flexible storage for additional data
  timestamp       DateTime @default(now())
  status          String   @default("NEW") // NEW, TRADED, DISMISSED, EXPIRED

  @@map("signals")
}

model TrackedWallet {
  id                String   @id @default(cuid())
  address           String   @unique
  label             String?
  trades            Int      @default(0)
  volume            Float    @default(0)
  createdAt         DateTime @default(now())
  
  snapshots         WalletSnapshot[]
  copySettings      CopySetting[]
  performance       WalletPerformance?
  tradeExecutions   CopyTradeExecution[]

  @@map("tracked_wallets")
}

model WalletSnapshot {
  id        String   @id @default(cuid())
  walletId  String
  
  pnl       Float
  volume    Float
  trades    Int
  timestamp DateTime @default(now())
  
  trackedWallet TrackedWallet @relation(fields: [walletId], references: [id])

  @@index([walletId, timestamp])
  @@map("wallet_snapshots")
}

model CopySetting {
  id              String   @id @default(cuid())
  userId          Int
  walletId        String
  
  label           String?
  enabled         Boolean  @default(true)
  inverse         Boolean  @default(false)
  
  copyMode        String   // "fixed", "percentage", "kelly"
  fixedAmount     Float?   
  percentageAmount Float?  
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User            @relation(fields: [userId], references: [id])
  trackedWallet   TrackedWallet   @relation(fields: [walletId], references: [id])

  @@unique([userId, walletId])
  @@map("copy_settings")
}

// NEW: Individual copied trade execution
model CopyTradeExecution {
  id              String   @id @default(cuid())
  userId          Int
  walletId        String
  
  // Trade Info
  marketId        String
  marketTitle     String
  outcome         String   // "YES" or "NO"
  amount          Float
  price           Float
  shares          Float
  
  // Performance
  entryPrice      Float
  currentPrice    Float?   @default(0)
  exitPrice       Float?
  pnl             Float    @default(0)
  pnlPercent      Float    @default(0)
  
  // Risk Management
  status          String   // "OPEN", "CLOSED", "STOPPED"
  stopLossPrice   Float?
  takeProfitPrice Float?
  
  // Category
  category        String   @default("unknown")
  
  // Timestamps
  entryTime       DateTime @default(now())
  exitTime        DateTime?
  
  trackedWallet   TrackedWallet @relation(fields: [walletId], references: [id])
  
  @@index([userId, status])
  @@index([walletId, entryTime])
  @@map("copy_trade_executions")
}

// NEW: Advanced wallet performance metrics
model WalletPerformance {
  id              String   @id @default(cuid())
  walletId        String   @unique
  
  // Advanced Metrics  
  sharpeRatio     Float    @default(0)
  sortinoRatio    Float    @default(0)
  calmarRatio     Float    @default(0)
  maxDrawdown     Float    @default(0)
  profitFactor    Float    @default(0)
  kellyPercentage Float    @default(0)
  riskOfRuin      Float    @default(0)
  
  // Consistency
  winStreak       Int      @default(0)
  lossStreak      Int      @default(0)
  maxWinStreak    Int      @default(0)
  maxLossStreak   Int      @default(0)
  
  // Activity
  avgHoldTime     Float    @default(0) // hours
  avgTradeSize    Float    @default(0)
  avgWin          Float    @default(0)
  avgLoss         Float    @default(0)
  
  // Scores
  smartScore      Int      @default(0)  // 0-100
  farmScore       Int      @default(0)  // 0-100
  
  // Updated
  lastCalculated  DateTime @default(now())
  
  trackedWallet   TrackedWallet @relation(fields: [walletId], references: [id])
  
  @@map("wallet_performance")
}

// NEW: Portfolio allocation and risk limits
model PortfolioAllocation {
  id              String   @id @default(cuid())
  userId          Int      @unique
  
  // Capital
  totalCapital    Float    @default(0)
  allocatedCapital Float   @default(0)
  reserveCash     Float    @default(0)
  
  // Risk Limits
  maxPerWallet    Float    @default(20)  // %
  maxPerCategory  Float    @default(40)  // %
  dailyLossLimit  Float    @default(500) // $
  
  // Targets
  targetROI       Float    @default(20)  // %
  targetSharpe    Float    @default(1.5)
  
  // Status
  stopLossActive  Boolean  @default(true)
  
  @@map("portfolio_allocations")
}

model Alert {
  id     String @id @default(cuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id])

  // Alert Configuration
  name     String
  type     String // "PRICE_THRESHOLD", "VOLUME_SPIKE", "KEYWORD", "SCORE_TRIGGER", "WALLET_ACTIVITY"
  isActive Boolean @default(true)

  // Conditions (JSON for flexibility)
  conditions Json // { minScore: 80, keywords: ["Trump"], maxPrice: 0.7, walletAddress: "0x..." }

  // Notifications
  telegramEnabled Boolean @default(false)
  emailEnabled    Boolean @default(false)
  webEnabled      Boolean @default(true)

  // Tracking
  triggeredCount Int       @default(0)
  lastTriggered  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("alerts")
}

model MarketSnapshot {
  id       String @id @default(cuid())
  marketId String

  // Metrics at this point in time
  score       Int
  volume      Float
  liquidity   Float
  probability Float

  timestamp DateTime @default(now())

  @@index([marketId, timestamp])
  @@map("market_snapshots")
}

// Cache for Polymarket market details (slug, title, description)
// Used to generate accurate links across all modules
model MarketCache {
  id          String   @id // The Polymarket condition_id or market_id
  slug        String   // URL slug e.g. "will-trump-win-2024"
  title       String   // Human readable title
  description String?  // Market description
  imageUrl    String?  // Optional thumbnail
  resolved    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt


  @@map("market_cache")
}

// ============================================================================
// WHALE RADAR MODULE - Transaction Tracking & Intelligent Tagging
// ============================================================================

// Records every whale transaction detected on Polygon blockchain
model WhaleTransaction {
  id              String   @id @default(cuid())
  
  // Blockchain Data
  txHash          String   @unique
  blockNumber     Int
  timestamp       DateTime
  gasPrice        Float
  
  // Wallet Info
  walletAddress   String
  walletTag       String   // WINNER, LOOSER, INSIDER, SMART_MONEY, DUMB_MONEY, UNKNOWN
  walletWinRate   Float?   // % historical win rate
  walletTotalPnl  Float?   // Total PnL in USD
  
  // Transaction Details
  marketId        String
  marketQuestion  String
  marketSlug      String   // For constructing Polymarket URLs
  outcome         String   // YES, NO, or other
  amount          Float    // Amount in USD
  price           Float    // Exact price at order time
  shares          Float    // Number of shares purchased
  
  // Clustering
  clusterName     String?  // If part of a detected wallet cluster
  
  // Metadata
  createdAt       DateTime @default(now())
  
  // Relations
  whale           WhaleProfile? @relation(fields: [walletAddress], references: [address])
  
  @@index([walletAddress, timestamp])
  @@index([timestamp(sort: Desc)])
  @@index([walletTag])
  @@map("whale_transactions")
}

// Profile and metrics for each whale wallet
model WhaleProfile {
  id              String   @id @default(cuid())
  address         String   @unique
  
  // Classification
  currentTag      String   // Current calculated tag
  tagHistory      Json     // Historical tags over time
  
  // Performance Metrics
  totalTrades     Int      @default(0)
  totalVolume     Float    @default(0)
  totalPnl        Float    @default(0)
  winRate         Float    @default(0)
  avgPositionSize Float    @default(0)
  
  // Streaks
  currentStreak   Int      @default(0)  // Positive = wins, negative = losses
  maxWinStreak    Int      @default(0)
  maxLossStreak   Int      @default(0)
  
  // Timing
  firstSeen       DateTime @default(now())
  lastSeen        DateTime @default(now())
  lastUpdated     DateTime @updatedAt
  
  // Relations
  transactions    WhaleTransaction[]
  
  @@index([currentTag])
  @@index([totalPnl(sort: Desc)])
  @@index([winRate(sort: Desc)])
  @@map("whale_profiles")
}

// Wallet clustering - detect coordinated trading patterns
model WalletCluster {
  id              String   @id @default(cuid())
  clusterName     String   @unique // e.g., "Cluster_ABC123"
  
  // Detection
  confidence      Float    // 0-1 confidence score
  detectionMethod String   // "SAME_TX_TIMING", "SAME_MARKET_PATTERN", "MANUAL"
  
  // Member wallets (JSON array for flexibility)
  addresses       Json     // ["0x123...", "0x456..."]
  
  // Stats
  totalMembers    Int      @default(0)
  totalVolume     Float    @default(0)
  firstDetected   DateTime @default(now())
  lastActivity    DateTime @default(now())
  
  @@map("wallet_clusters")
}

