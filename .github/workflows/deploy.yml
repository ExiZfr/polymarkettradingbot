name: ğŸš€ Auto Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          POLYGON_RPC_WSS: ${{ secrets.POLYGON_RPC_WSS }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: GITHUB_TOKEN,DATABASE_URL,POLYGON_RPC_WSS
          script_stop: false
          debug: true
          script: |
            set -x
            set -e
            export PATH=$PATH:/usr/local/bin
            
            echo "========================================"
            echo "ğŸš€ STARTING AUTO-DEPLOYMENT"
            echo "========================================"
            
            # Debug Info
            echo "ğŸ‘¤ User: $(whoami)"
            echo "ğŸ  Home: $HOME"
            echo "ğŸ“‚ PWD: $(pwd)"
            
            # Configuration
            APP_DIR="$HOME/PolygraalX"
            REPO_URL="https://${GITHUB_TOKEN}@github.com/ExiZfr/PolygraalX.git"
            
            echo "ğŸ¯ Target: $APP_DIR"
            
            # Update specific env vars without overwriting the whole file
            echo "ğŸ“ Updating .env file..."
            mkdir -p "$APP_DIR"
            
            # Create .env if doesn't exist
            touch "$APP_DIR/.env"
            
            # Function to update or add env var
            update_env() {
              local key="$1"
              local value="$2"
              local file="$APP_DIR/.env"
              if grep -q "^${key}=" "$file"; then
                sed -i "s|^${key}=.*|${key}=${value}|" "$file"
              else
                echo "${key}=${value}" >> "$file"
              fi
            }
            
            # Update required vars
            update_env "DATABASE_URL" "$DATABASE_URL"
            update_env "NEXT_PUBLIC_APP_URL" "https://polygraalx.com"
            update_env "NEXT_PUBLIC_BOT_USERNAME" "PolyGraalXBot"
            update_env "SESSION_SECRET" "polygraalx_super_secret_session_key_2024"
            update_env "TELEGRAM_BOT_TOKEN" "8042171984:AAHQyOuxL47aDVtc41FKWfUCD3eMn7_0kp0"
            update_env "TELEGRAM_ADMIN_CHAT_ID" "7139453099"
            
            # Whale Tracker Configuration
            update_env "WHALE_TRACKER_MODE" "production"
            update_env "MIN_WHALE_AMOUNT" "5000"
            update_env "API_BASE_URL" "http://localhost:3001"
            
            # Polygon RPC (if provided in secrets)
            if [ -n "$POLYGON_RPC_WSS" ]; then
                update_env "POLYGON_RPC_WSS" "$POLYGON_RPC_WSS"
                echo "âœ… POLYGON_RPC_WSS configured for production mode"
            else
                echo "âš ï¸ POLYGON_RPC_WSS not provided - will use simulation mode"
                update_env "WHALE_TRACKER_MODE" "simulation"
            fi
            
            echo "âœ… Env vars updated (all tokens configured)"
            
            # Check if directory exists
            if [ -d "$APP_DIR" ]; then
              echo "âœ… Directory exists. Navigating..."
              cd "$APP_DIR" || exit 1
              
              echo "ğŸ“¥ [1/6] Syncing with GitHub..."
              # Update remote to use current token (in case it changed)
              git remote set-url origin "$REPO_URL"
              
              # Fetch and Reset
              git fetch origin main
              git reset --hard origin/main
            else
              echo "âš ï¸ Directory not found. Cloning repository..."
              
              # Ensure parent dir exists
              cd "$HOME"
              
              # Clone using HTTPS + Token
              git clone "$REPO_URL" PolygraalX
              cd "$APP_DIR" || exit 1
            fi
            
            echo "ğŸ“¦ [2/6] Installing dependencies..."
            npm install
            
            echo "ğŸ—„ï¸ [3/6] Syncing database..."
            npx prisma generate
            npx prisma db push
            
            echo "ğŸ—ï¸ [4/6] Building Next.js app..."
            npm run build
            
            echo "â™»ï¸ [5/6] Restarting Main Application..."
            # Check if pm2 is installed
            if ! command -v pm2 &> /dev/null; then
                echo "âŒ PM2 not found. Installing global pm2..."
                npm install -g pm2
            fi

            # Start or Restart Main App using PM2
            if pm2 describe polygraalx > /dev/null 2>&1; then
                echo "ğŸ”„ Restarting existing main app..."
                pm2 restart polygraalx
            else
                echo "â–¶ï¸ Starting new main app process..."
                pm2 start npm --name polygraalx -- start
            fi
            
            echo "ğŸ“¡ [6/6] Starting Background Services..."
            
            # STOP old radar system
            pm2 stop polyradar-whale-tracker 2>/dev/null || true
            pm2 delete polyradar-whale-tracker 2>/dev/null || true
            
            # STOP crashing sniper first to prevent restart loops
            pm2 stop polysniper 2>/dev/null || true
            pm2 delete polysniper 2>/dev/null || true
            
            # Install Python dependencies for ALL services
            echo "ğŸ Installing Python dependencies..."
            
            # FIRST: Ensure pip is installed
            if ! command -v pip3 &> /dev/null; then
                echo "ğŸ“¦ Installing pip3..."
                apt-get update -qq && apt-get install -y python3-pip || echo "Could not install pip via apt"
            fi
            
            # For sniper
            python3 -m pip install --user httpx || pip3 install httpx || apt-get install -y python3-httpx 2>/dev/null || echo "httpx installation attempts completed"
            
            # For NEW whale tracker (IMPORTANT!)
            if [ -f "scripts/whale_tracker_requirements.txt" ]; then
              echo "ğŸ“¦ Installing whale tracker dependencies..."
              
              # Try pip first
              if command -v pip3 &> /dev/null; then
                pip3 install -r scripts/whale_tracker_requirements.txt || python3 -m pip install --user -r scripts/whale_tracker_requirements.txt || echo "pip install failed, trying apt..."
              fi
              
              # Fallback to apt for individual packages
              apt-get install -y python3-web3 python3-aiohttp python3-dotenv 2>/dev/null || echo "apt install attempts completed"
            fi
            
            # Verify installations
            python3 -c "import httpx; print('âœ… httpx installed successfully')" || echo "âš ï¸ httpx not available"
            python3 -c "import web3; print('âœ… web3 installed successfully')" || echo "âš ï¸ web3 not available"
            python3 -c "import aiohttp; print('âœ… aiohttp installed successfully')" || echo "âš ï¸ aiohttp not available"
            
            # Start or Restart Listener Service
            if pm2 describe polylistener > /dev/null 2>&1; then
                echo "ğŸ”„ Restarting listener service..."
                pm2 restart polylistener
            else
                echo "â–¶ï¸ Starting listener service..."
                pm2 start scripts/hyper-listener.js --name polylistener
            fi
            
            # Start Python Sniper Bot (fresh start)
            echo "ğŸ¯ Starting sniper bot..."
            pm2 start scripts/polymarket_sniper.py --name polysniper --interpreter python3 --no-autorestart
            
            # Start NEW Whale Tracker v2.0 (PRODUCTION MODE - REAL BLOCKCHAIN DATA)
            echo "ğŸ‹ Starting NEW Whale Tracker v2.0 in PRODUCTION MODE..."
            
            # Stop any existing whale-tracker
            pm2 stop whale-tracker 2>/dev/null || true
            pm2 delete whale-tracker 2>/dev/null || true
            
            # Configure environment for PRODUCTION mode
            echo "ğŸ”„ Configuring production environment..."
            
            # Add POLYGON_RPC_WSS to .env if not exists
            if ! grep -q "^POLYGON_RPC_WSS=" .env; then
                echo "âš ï¸ POLYGON_RPC_WSS not found in .env"
                echo "ğŸ’¡ Add your Alchemy/Infura WebSocket URL to GitHub Secrets"
                echo "ğŸ“ For now, falling back to simulation mode..."
                export WHALE_TRACKER_MODE=simulation
            else
                echo "âœ… POLYGON_RPC_WSS configured"
                export WHALE_TRACKER_MODE=production
            fi
            
            export API_BASE_URL=http://localhost:3001
            export MIN_WHALE_AMOUNT=5000
            
            # START whale-tracker with configured mode
            pm2 start scripts/whale_tracker.py \
              --name whale-tracker \
              --interpreter python3 \
              --restart-delay 10000 \
              --max-restarts 5
            
            # Wait for startup
            sleep 3
            
            # Verify whale-tracker is running
            if pm2 describe whale-tracker > /dev/null 2>&1; then
                echo "âœ… whale-tracker started successfully"
                pm2 logs whale-tracker --lines 20 --nostream || true
            else
                echo "âŒ whale-tracker failed to start!"
                python3 scripts/whale_tracker.py 2>&1 | head -30 || true
            fi
            
            # Save PM2 config
            pm2 save
            
            # Show status
            pm2 status
            
            echo "========================================"
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "ğŸŒ Main App: polygraalx (port 3001)"
            echo "ğŸ“¡ Listener: polylistener"
            echo "ğŸ¯ Sniper: polysniper"
            echo "ğŸ‹ Whale Tracker: whale-tracker (NEW v2.0)"
            echo "========================================"

