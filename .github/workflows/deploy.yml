name: ğŸš€ Auto Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

          script: |
            # ğŸ›‘ STOP immediately if any command fails
            set -e
            
            cd ~/polymarkettradingbot
            
            echo "========================================"
            echo "ğŸš€ STARTING AUTO-DEPLOYMENT"
            echo "========================================"
            
            echo "ğŸ“¥ [1/5] Pulling latest changes..."
            git pull origin main
            
            echo "ğŸ“¦ [2/5] Installing dependencies..."
            npm install
            
            echo "ğŸ—„ï¸ [3/5] Syncing database..."
            npx prisma generate
            npx prisma db push
            
            echo "ğŸ—ï¸ [4/5] Building Next.js app..."
            # Run build. If it fails, the script stops here due to set -e
            # The previous version keeps running in PM2
            if npm run build; then
                echo "âœ… Build success!"
            else
                echo "âŒ CRITICAL ERROR: Build failed!"
                echo "âš ï¸ Check the error logs above in 'Building Next.js app'"
                echo "â›” Deployment aborted. Old version is still running."
                exit 1
            fi
            
            echo "â™»ï¸ [5/5] Restarting Application..."
            pm2 restart polymarket-dashboard || pm2 start npm --name polymarket-dashboard -- start
            
            echo "========================================"
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "========================================"
