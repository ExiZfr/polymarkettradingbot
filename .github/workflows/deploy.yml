name: ğŸš€ Auto Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: GITHUB_TOKEN,DATABASE_URL
          script_stop: false
          debug: true
          script: |
            set -x
            set -e
            export PATH=$PATH:/usr/local/bin
            
            echo "========================================"
            echo "ğŸš€ STARTING AUTO-DEPLOYMENT"
            echo "========================================"
            
            # Debug Info
            echo "ğŸ‘¤ User: $(whoami)"
            echo "ğŸ  Home: $HOME"
            echo "ğŸ“‚ PWD: $(pwd)"
            
            # Configuration
            APP_DIR="$HOME/PolygraalX"
            REPO_URL="https://${GITHUB_TOKEN}@github.com/ExiZfr/PolygraalX.git"
            
            echo "ğŸ¯ Target: $APP_DIR"
            
            # Update specific env vars without overwriting the whole file
            echo "ğŸ“ Updating .env file..."
            mkdir -p "$APP_DIR"
            
            # Create .env if doesn't exist
            touch "$APP_DIR/.env"
            
            # Function to update or add env var
            update_env() {
              local key="$1"
              local value="$2"
              local file="$APP_DIR/.env"
              if grep -q "^${key}=" "$file"; then
                sed -i "s|^${key}=.*|${key}=${value}|" "$file"
              else
                echo "${key}=${value}" >> "$file"
              fi
            }
            
            # Update required vars
            update_env "DATABASE_URL" "$DATABASE_URL"
            update_env "NEXT_PUBLIC_APP_URL" "https://polygraalx.com"
            update_env "NEXT_PUBLIC_BOT_USERNAME" "PolyGraalXBot"
            update_env "SESSION_SECRET" "polygraalx_super_secret_session_key_2024"
            update_env "TELEGRAM_BOT_TOKEN" "8042171984:AAHQyOuxL47aDVtc41FKWfUCD3eMn7_0kp0"
            update_env "TELEGRAM_ADMIN_CHAT_ID" "7139453099"
            
            echo "âœ… Env vars updated (all tokens configured)"
            
            # Check if directory exists
            if [ -d "$APP_DIR" ]; then
              echo "âœ… Directory exists. Navigating..."
              cd "$APP_DIR" || exit 1
              
              echo "ğŸ“¥ [1/6] Syncing with GitHub..."
              # Update remote to use current token (in case it changed)
              git remote set-url origin "$REPO_URL"
              
              # Fetch and Reset
              git fetch origin main
              git reset --hard origin/main
            else
              echo "âš ï¸ Directory not found. Cloning repository..."
              
              # Ensure parent dir exists
              cd "$HOME"
              
              # Clone using HTTPS + Token
              git clone "$REPO_URL" PolygraalX
              cd "$APP_DIR" || exit 1
            fi
            
            echo "ğŸ“¦ [2/6] Installing dependencies..."
            npm install
            
            echo "ğŸ—„ï¸ [3/6] Syncing database..."
            npx prisma generate
            npx prisma db push
            
            echo "ğŸ—ï¸ [4/6] Building Next.js app..."
            npm run build
            
            echo "â™»ï¸ [5/6] Restarting Main Application..."
            # Check if pm2 is installed
            if ! command -v pm2 &> /dev/null; then
                echo "âŒ PM2 not found. Installing global pm2..."
                npm install -g pm2
            fi

            # Start or Restart Main App using PM2
            if pm2 describe polygraalx > /dev/null 2>&1; then
                echo "ğŸ”„ Restarting existing main app..."
                pm2 restart polygraalx
            else
                echo "â–¶ï¸ Starting new main app process..."
                pm2 start npm --name polygraalx -- start
            fi
            
            echo "ğŸ“¡ [6/6] Starting Background Services..."
            
            # STOP crashing sniper first to prevent restart loops
            pm2 stop polysniper 2>/dev/null || true
            pm2 delete polysniper 2>/dev/null || true
            
            # Install Python dependencies for sniper (FORCE)
            echo "ğŸ Installing Python dependencies..."
            python3 -m pip install --user httpx || pip3 install httpx || apt-get install -y python3-httpx 2>/dev/null || echo "Trying system python..."
            
            # Verify httpx is installed
            python3 -c "import httpx; print('âœ… httpx installed successfully')" || echo "âŒ httpx still not installed"
            
            # Start or Restart Listener Service
            if pm2 describe polylistener > /dev/null 2>&1; then
                echo "ğŸ”„ Restarting listener service..."
                pm2 restart polylistener
            else
                echo "â–¶ï¸ Starting listener service..."
                pm2 start scripts/hyper-listener.js --name polylistener
            fi
            
            # Start Python Sniper Bot (fresh start)
            echo "ğŸ¯ Starting sniper bot..."
            pm2 start scripts/polymarket_sniper.py --name polysniper --interpreter python3 --no-autorestart
            
            # Save PM2 config
            pm2 save
            
            # Show status
            pm2 status
            
            echo "========================================"
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "ğŸŒ Main App: polygraalx (port 3001)"
            echo "ğŸ“¡ Listener: polylistener"
            echo "ğŸ¯ Sniper: polysniper"
            echo "========================================"

